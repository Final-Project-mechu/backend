name: Deploy to Amazon EC2

on:
  push:
    branches:
      - main

# ë³¸ì¸ì´ ì„¤ì •í•œ ê°’ì„ ì—¬ê¸°ì„œ ì±„ì›Œë„£ìŠµë‹ˆë‹¤.
# ë¦¬ì „, ë²„í‚· ì´ë¦„, CodeDeploy ì•± ì´ë¦„, CodeDeploy ë°°í¬ ê·¸ë£¹ ì´ë¦„
env:
  AWS_REGION: ap-northeast-2
  S3_BUCKET_NAME: my-github-actions-a3-bucket2
  CODE_DEPLOY_APPLICATION_NAME: my-codedeploy-app
  CODE_DEPLOY_DEPLOYMENT_GROUP_NAME: my-codedeploy-deployment-group

permissions:
  contents: read

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    environment: production

    steps:
      # (1) ê¸°ë³¸ ì²´í¬ì•„ì›ƒ
      - name: Checkout
        uses: actions/checkout@v3

      # (2) Node.js ì„¸íŒ…
      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '18.x'

      # í™˜ê²½ë³€ìˆ˜ ì„¸íŒ…
      - name: âš™ï¸ í™˜ê²½ë³€ìˆ˜ ì„¤ì •
        working-directory: ./
        env:
         DATABASE_HOST: ${{ secrets.DATABASE_HOST }}
         DATABASE_PORT: ${{ secrets.DATABASE_PORT }}
         DATABASE_USERNAME: ${{ secrets.DATABASE_USERNAME }}
         DATABASE_PASSWORD: ${{ secrets.DATABASE_PASSWORD }}
         DATABASE_NAME: ${{ secrets.DATABASE_NAME }}
         JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}
        run: |
         pwd
         touch .env
         echo "DATABASE_HOST=$DATABASE_HOST" >> .env
         echo "DATABASE_PORT=$DATABASE_PORT" >> .env
         echo "DATABASE_USERNAME=$DATABASE_USERNAME" >> .env
         echo "DATABASE_PASSWORD=$DATABASE_PASSWORD" >> .env
         echo "DATABASE_NAME=$DATABASE_NAME" >> .env
         echo "JWT_SECRET_KEY=$JWT_SECRET_KEY" >> .env
         cat .env
  
      - name: âœ¨ íŒ¨í‚¤ì§€ ì„¤ì¹˜
        working-directory: ./
        run: npm install

      - name: âœ¨ ë¹Œë“œ ê³¼ì •ì„ ì‹œì‘
        working-directory: ./
        run: npm run build

      - name: ğŸ“¦ ë¹Œë“œí•œ ì½”ë“œë¥¼ ì••ì¶•
        run: zip -r backend.zip ./dist ./scripts ./appspec.yml ./.env ./package.json ./eslintrc.js ./prettierrc ./webpack-hmr.config.js

      - name: ğŸŒ AWSì— ì ‘ì†
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_TEST1 }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_TEST1 }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ğŸ¦– S3ì— ì••ì¶•ëœ ì„œë²„ ì½”ë“œë¥¼ ì—…ë¡œë“œ
        run: aws s3 cp --region ${{ env.AWS_REGION }} ./backend.zip s3://my-github-actions-a3-bucket2

      - name: ğŸš€ AWS codeDeployë¡œ ë°°í¬ë¥¼ ì‹œì‘
        run: aws deploy create-deployment
          --ignore-application-stop-failures
          --application-name ${{ env.CODE_DEPLOY_APPLICATION_NAME }}
          --deployment-config-name CodeDeployDefault.AllAtOnce
          --deployment-group-name ${{ env.CODE_DEPLOY_DEPLOYMENT_GROUP_NAME }}
          --s3-location bucket=$S3_BUCKET_NAME,key=backend.zip,bundleType=zip
        
      #   # (3) build (Test ì œì™¸)
      # - name: Install dependencies
      #   run: npm install
  
      # - name: Build test
      #   run: npm run build
        
      # # (4) AWS ì¸ì¦ (IAM ì‚¬ìš©ì Access Key, Secret Key í™œìš©)
      # - name: Configure AWS credentials
      #   uses: aws-actions/configure-aws-credentials@v1
      #   with:
      #     aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_TEST1 }}
      #     aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_TEST1 }}
      #     aws-region: ${{ env.AWS_REGION }}
      
      # # (5) ë¹Œë“œ ê²°ê³¼ë¬¼ì„ S3 ë²„í‚·ì— ì—…ë¡œë“œ
      # - name: Upload to AWS S3
      #   run: |
      #     aws deploy push \
      #       --application-name ${{ env.CODE_DEPLOY_APPLICATION_NAME }} \
      #       --ignore-hidden-files \
      #       --s3-location s3://$S3_BUCKET_NAME/$GITHUB_SHA.zip \
      #       --source .
      
      # # (6) S3 ë²„í‚·ì— ìˆëŠ” íŒŒì¼ì„ ëŒ€ìƒìœ¼ë¡œ CodeDeploy ì‹¤í–‰
      # - name: Deploy to AWS EC2 from S3
      #   run: |
      #     aws deploy create-deployment \
      #       --application-name ${{ env.CODE_DEPLOY_APPLICATION_NAME }} \
      #       --deployment-config-name CodeDeployDefault.AllAtOnce \
      #       --deployment-group-name ${{ env.CODE_DEPLOY_DEPLOYMENT_GROUP_NAME }} \
      #       --s3-location bucket=$S3_BUCKET_NAME,key=$GITHUB_SHA.zip,bundleType=zip
